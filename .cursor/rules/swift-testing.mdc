---
description: "Swift Testing 패턴, @Test 매크로, #expect/#require 어설션, 비동기 테스트, 매개변수화된 테스트, TestStore 사용. 테스트 작성 또는 수정, 테스트 스위트 설정 시 적용."
globs: ["Tests/**/*.swift", "**/*Tests.swift", "**/*Test.swift"]
alwaysApply: false
---

# Swift Testing Guidelines for InnoFlow

## Modern Testing with @Test Macros

모든 테스트는 **Swift Testing** 프레임워크를 사용합니다 (XCTest 아님). 테스트는 `Tests/` 디렉토리에 위치합니다.

### Basic Test Structure

```swift
import Testing
import InnoDICore
import SwiftParser
import SwiftSyntax

@Test("Parse Provide attribute with shared scope")
func parseProvideShared() {
    let source = """
    @Provide(.shared, factory: APIClient())
    var api: APIClient
    """
    let tree = Parser.parse(source: source)
    // 파싱 로직 테스트...
}
```

## 테스트 타겟 구조

### InnoDICoreTests

코어 파싱 로직을 테스트합니다:
- `parseProvideArguments()`: `@Provide` 속성 파싱
- `parseDIContainerAttribute()`: `@DIContainer` 속성 파싱
- `findAttribute()`: 속성 찾기 헬퍼

### InnoDIMacrosTests

매크로 확장을 테스트합니다:
- `SwiftSyntaxMacrosTestSupport`를 사용하여 매크로 확장 검증
- `@DIContainer` 매크로가 올바른 `init` 및 `Overrides` struct 생성 확인

## 필수 패턴

1. **@Test 매크로 사용** - XCTest의 test prefix 대신
2. **#expect 및 #require 사용** - XCTAssert 대신
3. **설명적인 테스트 이름** - 문자열 매개변수로 포함
4. **SwiftSyntax 파싱** - `Parser.parse()`를 사용하여 소스 코드 파싱
5. **#require 사용** - 실패 시 테스트 중단이 필요한 경우

### 주요 Swift Testing 기능

- **@Test**: 테스트 함수 표시 (XCTest의 test prefix 대체)
- **@Suite**: 관련 테스트 그룹화
- **#expect**: 조건 검증 (XCTest의 XCTAssert 대체)
- **#require**: #expect와 유사하지만 실패 시 테스트 실행 중단
- **매개변수화된 테스트**: 데이터 기반 테스트를 위한 @Test와 arguments
- **async/await**: 비동기 코드 테스트 완전 지원
- **Traits**: `.bug()`, `.feature()` 또는 사용자 정의 태그와 같은 메타데이터 추가

## 테스트 구성

### Test Suites

```swift
@Suite("Parsing Tests")
struct ParsingTests {
    
    @Test("Parse Provide attribute with shared scope")
    func parseProvideShared() {
        let source = """
        @Provide(.shared, factory: APIClient())
        var api: APIClient
        """
        let tree = Parser.parse(source: source)
        // 파싱 로직 검증...
    }
    
    @Test("Parse Provide attribute with input scope")
    func parseProvideInput() {
        let source = """
        @Provide(.input)
        var userId: String
        """
        let tree = Parser.parse(source: source)
        // 파싱 로직 검증...
    }
}
```

### 매개변수화된 테스트

```swift
@Test("Parse DIContainer attribute", arguments: [
    ("validate: true", true, false),
    ("root: true", true, true),
    ("validate: false, root: true", false, true)
])
func parseDIContainer(attribute: String, expectedValidate: Bool, expectedRoot: Bool) {
    let source = """
    @DIContainer(\(attribute))
    struct Container {}
    """
    // 파싱 및 검증...
}
```

## 매크로 확장 테스트 패턴

### DIContainer 매크로 테스트

```swift
import SwiftSyntaxMacros
import SwiftSyntaxMacrosTestSupport

@Test("DIContainer generates init with input dependencies")
func diContainerGeneratesInit() {
    assertMacroExpansion(
        """
        @DIContainer
        struct AppContainer {
            @Provide(.input)
            var userId: String
            
            @Provide(.shared, factory: APIClient())
            var api: APIClient
        }
        """,
        expandedSource: """
        struct AppContainer {
            @Provide(.input)
            var userId: String
            
            @Provide(.shared, factory: APIClient())
            var api: APIClient
            
            public struct Overrides {
                public var api: APIClient?
                public init() {}
            }
            
            public init(overrides: Overrides = .init(), userId: String) {
                let api = overrides.api ?? APIClient()
                self.userId = userId
                self.api = api
            }
        }
        """,
        macros: testMacros
    )
}
```

## 파싱 테스트 요구사항

### SwiftSyntax 사용

파싱 테스트는 `SwiftParser`를 사용하여 소스 코드를 파싱합니다:

```swift
import SwiftParser
import SwiftSyntax

@Test("Parse attribute arguments")
func parseArguments() {
    let source = """
    @Provide(.shared, factory: APIClient())
    var api: APIClient
    """
    let tree = Parser.parse(source: source)
    // 구문 트리에서 속성 찾기 및 파싱...
}
```

### 매크로 확장 검증

매크로 테스트는 `SwiftSyntaxMacrosTestSupport`를 사용합니다:

```swift
import SwiftSyntaxMacros
import SwiftSyntaxMacrosTestSupport

let testMacros: [String: Macro.Type] = [
    "DIContainer": DIContainerMacro.self,
    "Provide": ProvideMacro.self
]
```

## 모범 사례

### 테스트 구성
- **소스 파일당 하나의 테스트 파일** (가능한 경우)
- **Happy path와 edge case 모두 테스트**
- **검증하는 내용을 설명하는 설명적인 테스트 이름** 사용
- **테스트 분류를 위한 @Tag 추가** (예: `.unit`, `.integration`)
- **필요한 경우 테스트 메서드에 setup/teardown 포함**

### 테스트 품질
- **파싱 로직은 다양한 입력 형식 테스트**
- **`#expect(throws:)`로 에러 조건 테스트**
- **중요한 전제 조건에 #require 사용**
- **테스트를 단일 동작에 집중**
- **버그 수정에 대한 테스트 추가**하여 회귀 방지

### 매크로 확장 검증

매크로 테스트는 실제 확장 결과를 검증합니다:

```swift
@Test("DIContainer generates Overrides struct only when shared properties exist")
func diContainerOverridesConditional() {
    // shared 속성이 없는 경우 Overrides struct가 생성되지 않아야 함
    assertMacroExpansion(
        """
        @DIContainer
        struct Container {
            @Provide(.input)
            var userId: String
        }
        """,
        expandedSource: """
        struct Container {
            @Provide(.input)
            var userId: String
            
            public init(userId: String) {
                self.userId = userId
            }
        }
        """,
        macros: testMacros
    )
}
```

## 매크로 테스트

매크로 확장을 테스트하려면 `SwiftSyntaxMacrosTestSupport`를 사용합니다:

```swift
import SwiftSyntaxMacros
import SwiftSyntaxMacrosTestSupport
import InnoDIMacros

let testMacros: [String: Macro.Type] = [
    "DIContainer": DIContainerMacro.self,
    "Provide": ProvideMacro.self
]

@Test("DIContainer macro expands correctly")
func diContainerMacroExpansion() {
    assertMacroExpansion(
        """
        @DIContainer
        struct AppContainer {
            @Provide(.shared, factory: APIClient())
            var api: APIClient
        }
        """,
        expandedSource: """
        // 확장된 코드...
        """,
        macros: testMacros
    )
}
```

## 테스트 실행

테스트는 다음 명령으로 실행할 수 있습니다:

```bash
# 모든 테스트 실행
swift test

# 코어 파싱 테스트 실행
swift test --filter InnoDICoreTests

# 매크로 확장 테스트 실행
swift test --filter InnoDIMacrosTests

# 코드 커버리지와 함께 실행
swift test --enable-code-coverage --parallel
```

모든 테스트는 이러한 현대적인 Swift Testing 패턴을 따라야 하며 적절한 테스트 타겟 내에 위치해야 합니다.
